function pointsToPath(e){var t,n="";for(var r=0;r<e.length;r++){t=e[r];if(t.pageX===undefined||t.pageY===undefined)continue;r===0?n+="M":n+="L";n+=t.pageX+","+t.pageY}n+="Z";return n}function growBBox(e,t,n,r,i){if(t!==undefined&&n===undefined&&r===undefined&&i===undefined){n=t;r=t;i=t}else if(t!==undefined&&n!==undefined&&r===undefined&&i===undefined){r=t;i=n}else t!==undefined&&n!==undefined&&r!==undefined&&i===undefined&&(i=n);e.x-=i;e.y-=t;e.x2+=n;e.y2+=r;e.width+=n+i;e.height+=t+r;return e}function refreshUserPoly(){var e=sortedTouches.length;if(e<=2){if(userPoly!==null){userPoly.remove();userPoly=null}return}if(userPoly===null){userPoly=r.path();userPoly.attr({stroke:"black","stroke-opacity":.1,"stroke-dasharray":"-","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":5})}userPoly.attr("path",pointsToPath(sortedTouches))}function resetGame(){userLevel=0;nextLevel()}function initGameBoard(){var e=window.innerWidth,t=window.innerHeight,n=(e+t)/50;e-=n*2;t-=n*2;var i=window.innerWidth/2,s=window.innerHeight/2;userPolySet===null&&(userPolySet=r.set());userLivesSet===null&&(userLivesSet=r.set());var o=r.text(0,n/2|0,"Level "+userLevel).attr({fill:"#ffffff","text-anchor":"start","font-family":"Helvetica","font-size":n});boardPercent=0;boardPercentText=r.text(o.getBBox().width+n,n/2|0,boardPercent+"%").attr({fill:"#ffffff","text-anchor":"start","font-family":"Helvetica","font-size":n});for(var u=0;u<userLives;u++)userLivesSet.push(r.circle(window.innerWidth-(n/2|0)-n*u,n/2|0,n*.3).attr({fill:"#f00","stroke-width":0}));r.rect(i,s,0,0,5).toBack().attr({fill:"#fff"}).animate({width:e,height:t,x:i-e/2,y:s-t/2},1e3,"easeInOut",function(){gamePaused=!1;initGameBalls(userLevel)})}function nextLevel(){destroyGameBoard(function(){userLevel++;userLives=startingLives;initGameBoard()})}function destroyGameBoard(e){var t=r.bottom;gamePaused=!0;gameBalls!==null&&gameBalls.clear();userLivesSet!==null&&userLivesSet.clear();userPolySet!==null&&userPolySet.clear();if(t===null){e&&e();return}var n=t.attr("x")+t.attr("width")/2,i=t.attr("y")+t.attr("height")/2;t.animate({width:0,height:0,x:n,y:i},500,"easeInOut",function(){r.clear();e&&e()})}function initGameBalls(e){var t=r.bottom.getBBox(),n,i;gameBalls!==null&&gameBalls.clear();gameBalls=r.set();for(var s=0;s<e;s++){n=t.x+Math.floor(Math.random()*t.width)|0;i=t.y+Math.floor(Math.random()*t.height)|0;gameBalls.push(r.circle(n,i,(t.width+t.height)/140|0).attr({fill:"#f00","stroke-width":0}).data("m",1).data("vx",Math.random()*10-5).data("vy",Math.random()*10-5).data("cx",n).data("cy",i).data("checkedBall",{}))}animationLoop()}function moveBall(e,t,n,r,i){t+=r;n+=i;e.data("vx",r).data("vy",i).data("cx",t).data("cy",n).attr({cx:t|0,cy:n|0})}function animationLoop(e){e===undefined&&(e=+Date.now());var t=r.bottom,n=t.getBBox();gameBalls.forEach(function(e){var t=!1,r={};r[e.id]=!0;e.data("checkedBall",r);var i=e.data("cx"),s=e.data("cy"),o=e.attr("r"),u=e.data("m"),a=e.data("vx"),f=e.data("vy");gameBalls.forEach(function(n){var l=n.data("checkedBall");if(r[n.id]||l[e.id])return;var c=n.data("cx"),h=n.data("cy"),p=n.attr("r"),d=n.data("m"),v=n.data("vx"),m=n.data("vy"),g=c-i,y=h-s,b=a-v,w=f-m,E=o+p+1e-9;if(g*b+y*w>0&&g*g+y*y<=E*E){E-=1e-9;var S=(i-c)/E,x=(s-h)/E,T=a*S+f*x,N=v*S+m*x,C=2*(T-N)/(u+d);a-=C*S*d;f-=C*x*d;v+=C*S*u;m+=C*x*u;n.data("vx",v);n.data("vy",m);t=!0;return!1}r[n.id]=!0;l[e.id]=!0});if(t){moveBall(e,i,s,a,f);return}userPolySet.forEach(function(e){var n,r,u,l,c,h,p,d,v,m,g,y=e.attr("path");if(!Raphael.isPointInsideBBox(growBBox(Raphael.pathBBox(y),o),i,s))return;for(var b=0;b<y.length;b++){n=y[b];r=y[b+1];if(n[0]==="Z")continue;if(r===undefined||r[0]==="Z")r=y[0];u=n[1];l=n[2];c=r[1];h=r[2];if(u===c&&l===h)continue;if(!Raphael.isPointInsideBBox({x:Math.min(u,c),y:Math.min(l,h),x2:Math.max(u,c),y2:Math.max(l,h)},i,s))continue;p=h-l;d=c-u;v=p*p+d*d;var w=(i-u)*(h-l)-(s-l)*(c-u);w*=w;w/=v;if(w<(o+1e-9)*(o+1e-9)&&(g===undefined||w<g.d)){g={};g.d=w;g.p1x=u;g.p1y=l;g.p2x=c;g.p2y=h}}if(g!==undefined){p=g.p2y-g.p1y;d=g.p2x-g.p1x;v=Math.sqrt(p*p+d*d);p*=-1;p/=v;d/=v;m=a*p+f*d;a-=2*m*p;f-=2*m*d;if(e.data("filling")){userLives--;userLivesSet.pop().remove();solidifyUserPoly.call(e);userLives===0&&setTimeout(resetGame,500)}t=!0;return!1}});if(t){moveBall(e,i,s,a,f);return}if(i-o<=n.x){i=n.x+o;a*=-1}if(i+o>=n.x+n.width){i=n.x+n.width-o;a*=-1}if(s-o<=n.y){s=n.y+o;f*=-1}if(s+o>=n.y+n.height){s=n.y+n.height-o;f*=-1}moveBall(e,i,s,a,f)});gamePaused||window.requestAnimationFrame(animationLoop)}function compareTouches(e,t){var n=e.pageX,r=e.pageY,i=t.pageX,s=t.pageY,o=touchCenter.pageX,u=touchCenter.pageY;n-=o;r-=u;i-=o;s-=u;if(n===i&&r===s)return 0;if(n>=0&&i<0)return-1;if(n===0&&i===0)return r>s?-1:1;var a=n*s-i*r;return a<0?-1:a>0?1:n*n+r*r>i*i+s*s?-1:1}function setTouchesCenter(){var e=0,t=0,n=sortedTouches.length,r;if(n===0){touchCenter.pageX=null;touchCenter.pageY=null;return}if(n===1){r=sortedTouches[0];touchCenter.pageX=r.pageX;touchCenter.pageY=r.pageY;return}for(var i=0;i<n;i++){r=sortedTouches[i];e+=r.pageX;t+=r.pageY}e/=n;t/=n;touchCenter.pageX=e;touchCenter.pageY=t}function addTouch(e,t){e.pageX|=0;e.pageY|=0;var n=r.circle(e.pageX,e.pageY,fingerRadius);n.attr({"stroke-width":0,fill:"black","fill-opacity":.2});e.circle=n;touchesById[e.identifier]=e;sortedTouches.splice(0,0,e);if(t!==!1){setTouchesCenter();sortedTouches.sort(compareTouches);refreshUserPoly()}}function removeTouch(e,t){for(var n=0;n<sortedTouches.length;n++)if(sortedTouches[n].identifier===e){sortedTouches.splice(n,1);break}var r=touchesById[e];r.circle.remove();delete touchesById[e];if(t!==!1){setTouchesCenter();sortedTouches.sort(compareTouches);refreshUserPoly()}return r}function moveTouch(e){var t=touchesById[e.identifier];if(t===undefined)return;e.pageX|=0;e.pageY|=0;e.circle=t.circle;e.circle.attr({cx:e.pageX,cy:e.pageY});removeTouch(e.identifier,!1);addTouch(e)}function handleStart(e){e.preventDefault();var t=e.changedTouches;for(var n=0;n<t.length;n++){var r=t[n];addTouch(r)}}function handleMove(e){e.preventDefault();var t=e.changedTouches,n;for(var r=0;r<t.length;r++){n=t[r];moveTouch(n)}}function handleEnd(e){e.preventDefault();var t=e.changedTouches,n=Date.now(),r=500,i,s;if(userPoly&&n-lastTouchEnd>r){i=userPoly.attr("path");s={pageX:touchCenter.pageX,pageY:touchCenter.pageY};setTimeout(function(){sortedTouches.length===0&&fillUserPoly(i,s)},r)}for(var o=0;o<t.length;o++)removeTouch(t[o].identifier);lastTouchEnd=n}function fillUserPoly(e,t){var n=r.path("M"+t.pageX+","+t.pageY);userPolySet.push(n);n.data("filling",!0).attr({"stroke-width":0,fill:"#f00"}).animate({path:e},1e3,"linear",solidifyUserPoly)}function solidifyUserPoly(){var e=this.attr("path"),t,n,i;for(n=0;n<e.length;n++){t=e[n];for(i=0;i<t.length;i++)typeof t[i]=="number"&&(t[i]=t[i]|0)}this.stop().attr("path",e).attr("fill","#000").data("filling",!1);var s=r.bottom,o=s.attr("width")*s.attr("height"),u=0;userPolySet.forEach(function(e,t){var r=e.attr("path"),i=0,s,o;for(n=0;n<r.length;n++){s=r[n];if(s[0]==="Z")continue;n===r.length-1?o=r[0]:o=r[n+1];o[0]==="Z"&&(o=r[0]);i+=(s[1]+o[1])*(s[2]-o[2])}i/=2;userPolySet.forEach(function(e,u){if(u<=t)return;var a=e.attr("path"),f;f=Raphael.pathIntersection(r,a);if(f.length>0){var l=[];for(n=0;n<f.length;n++){l.push({pageX:f[n].x|0,pageY:f[n].y|0});addIfInsidePath(l,r,f[n].bez2[0],f[n].bez2[1]);addIfInsidePath(l,r,f[n].bez2[6],f[n].bez2[7]);addIfInsidePath(l,a,f[n].bez1[0],f[n].bez1[1]);addIfInsidePath(l,a,f[n].bez1[6],f[n].bez1[7])}l.sort(compareTouches);var c=0;for(n=0;n<l.length;n++){s=l[n];n===l.length-1?o=l[0]:o=l[n+1];c+=(o.pageX+s.pageX)*(o.pageY-s.pageY)}c/=2;i-=c}});u+=i});boardPercent=u/o*100|0;boardPercentText.attr({text:boardPercent+"%"});boardPercent>nextLevelPercent&&setTimeout(nextLevel,1e3)}function addIfInsidePath(e,t,n,r){Raphael.isPointInsidePath(t,n,r)&&e.push({pageX:n|0,pageY:r|0})}var r=null,userPolySet=null,touchesById={},sortedTouches=[],touchCenter={pageX:null,pageY:null},userPoly=null,lastTouchEnd=0,canvas=null,gameBalls=null,fingerRadius=30,nextLevelPercent=70,gamePaused=!0,userLevel=0,boardPercent=null,boardPercentText=null,startingLives=3,userLives=startingLives,userLivesSet=null;(function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n){window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),i=window.setTimeout(function(){t(n+r)},r);e=n+r;return i});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})})();Raphael(function(){canvas=document.getElementById("canvas");r=Raphael(canvas,"100%","100%");resetGame();canvas.addEventListener("touchstart",handleStart,!1);canvas.addEventListener("touchend",handleEnd,!1);canvas.addEventListener("touchcancel",handleEnd,!1);canvas.addEventListener("touchmove",handleMove,!1)});